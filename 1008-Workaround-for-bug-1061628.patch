From 2cb8559c823e436cef8122db2a251e2ba08f0f6a Mon Sep 17 00:00:00 2001
From: Jaroslav Pulchart <jaroslav.pulchart@gooddata.com>
Date: Tue, 9 Oct 2012 14:16:29 +0200
Subject: [PATCH 8/8] Workaround for bug #1061628

---
 bin/nova-networkvlan | 49 +++++++++++++++++++++++++++++++++++++++++++++++++
 nova/service.py      |  2 +-
 setup.py             |  1 +
 3 files changed, 51 insertions(+), 1 deletion(-)
 create mode 100755 bin/nova-networkvlan

diff --git a/bin/nova-networkvlan b/bin/nova-networkvlan
new file mode 100755
index 0000000..2a1ba56
--- /dev/null
+++ b/bin/nova-networkvlan
@@ -0,0 +1,49 @@
+#!/usr/bin/env python
+# vim: tabstop=4 shiftwidth=4 softtabstop=4
+
+# Copyright 2010 United States Government as represented by the
+# Administrator of the National Aeronautics and Space Administration.
+# All Rights Reserved.
+#
+#    Licensed under the Apache License, Version 2.0 (the "License"); you may
+#    not use this file except in compliance with the License. You may obtain
+#    a copy of the License at
+#
+#         http://www.apache.org/licenses/LICENSE-2.0
+#
+#    Unless required by applicable law or agreed to in writing, software
+#    distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
+#    WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
+#    License for the specific language governing permissions and limitations
+#    under the License.
+
+"""Starter script for Nova Network."""
+
+import eventlet
+eventlet.monkey_patch()
+
+import os
+import sys
+
+# If ../nova/__init__.py exists, add ../ to Python search path, so that
+# it will override what happens to be installed in /usr/(local/)lib/python...
+possible_topdir = os.path.normpath(os.path.join(os.path.abspath(sys.argv[0]),
+                                   os.pardir,
+                                   os.pardir))
+if os.path.exists(os.path.join(possible_topdir, 'nova', '__init__.py')):
+    sys.path.insert(0, possible_topdir)
+
+
+from nova import flags
+from nova import log as logging
+from nova import service
+from nova import utils
+
+if __name__ == '__main__':
+    utils.default_flagfile()
+    flags.FLAGS(sys.argv)
+    logging.setup()
+    utils.monkey_patch()
+    server = service.Service.create(binary='nova-network',topic='networkvlan')
+    service.serve(server)
+    service.wait()
diff --git a/nova/service.py b/nova/service.py
index 1da10e6..73b39ca 100644
--- a/nova/service.py
+++ b/nova/service.py
@@ -232,7 +232,7 @@ class Service(object):
         if not topic:
             topic = binary.rpartition('nova-')[2]
         if not manager:
-            manager = FLAGS.get('%s_manager' % topic, None)
+            manager = FLAGS.get('%s_manager' % binary.rpartition('nova-')[2], None)
         if report_interval is None:
             report_interval = FLAGS.report_interval
         if periodic_interval is None:
--
1.7.11.7
