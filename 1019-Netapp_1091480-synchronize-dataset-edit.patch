From e8c35626f457c09823689a2ceb2020bc6671d345 Mon Sep 17 00:00:00 2001
From: Brano Zarnovican <branislav.zarnovican@gooddata.com>
Date: Mon, 14 Jan 2013 12:51:27 +0100
Subject: [PATCH 2/7] BUGFIX: workaround for #1091480, synchronize dataset edit

---
 nova/volume/netapp.py | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/nova/volume/netapp.py b/nova/volume/netapp.py
index 43e65c9..d71586f 100644
--- a/nova/volume/netapp.py
+++ b/nova/volume/netapp.py
@@ -31,6 +31,7 @@ from suds.sax import text
 
 from nova import exception
 from nova import flags
+from nova import utils
 from nova.openstack.common import cfg
 from nova.openstack.common import log as logging
 from nova.volume import driver
@@ -368,6 +369,7 @@ class NetAppISCSIDriver(driver.ISCSIDriver):
         self.discovered_datasets.append(ds)
         return ds
 
+    @utils.synchronized('dfm-edit-lock')
     def _provision(self, name, description, project, ss_type, size):
         """Provision a LUN through provisioning manager.
 
@@ -428,6 +430,7 @@ class NetAppISCSIDriver(driver.ISCSIDriver):
             return None
         return volume_type['name']
 
+    @utils.synchronized('dfm-edit-lock')
     def _remove_destroy(self, name, project):
         """Remove the LUN from the dataset, also destroying it.
 
-- 
1.8.1.4

