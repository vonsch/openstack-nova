From 4e9bbf1f28c55485683c613fbacddb893e62d218 Mon Sep 17 00:00:00 2001
From: Jaroslav Pulchart <jaroslav.pulchart@gooddata.com>
Date: Wed, 12 Sep 2012 11:07:07 +0200
Subject: [PATCH 13/13] use local LVM volume instead of iSCSI device on same
 host with volume

---
 nova/virt/libvirt/volume.py | 16 +++++++++++++++-
 1 file changed, 15 insertions(+), 1 deletion(-)

diff --git a/nova/virt/libvirt/volume.py b/nova/virt/libvirt/volume.py
index 9680a05..9624e59 100644
--- a/nova/virt/libvirt/volume.py
+++ b/nova/virt/libvirt/volume.py
@@ -18,9 +18,11 @@
 """Volume drivers for libvirt."""
 
 import os
-from os.path import  basename
+from os.path import basename
+from os.path import islink
 import time
 
+from nova.api.ec2 import ec2utils
 from nova import exception
 from nova import flags
 from nova import log as logging
@@ -44,6 +46,18 @@ class LibvirtVolumeDriver(object):
         """Connect the volume. Returns xml for libvirt."""
         driver = self._pick_volume_driver()
         device_path = connection_info['data']['device_path']
+        volume_id = connection_info['data']['volume_id']
+
+        # TODO: ec2_volume_id have to be computed from FLAGS.volume_name_template
+        local_volume = "/dev/%s/%s" % (FLAGS.volume_group, ec2utils.id_to_ec2_vol_id(volume_id))
+        is_local_volume = islink(local_volume)
+
+        if is_local_volume:
+             device_path = local_volume
+             LOG.debug("Attaching local device %s as %s" % (local_volume, mount_device))
+        else:
+             LOG.debug("Attaching device %s as %s" % (device_path, mount_device))
+
         xml = """<disk type='block'>
                      <driver name='%s' type='raw' cache='none'/>
                      <source dev='%s'/>
-- 
1.7.11.4

