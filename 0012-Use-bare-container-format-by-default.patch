From 75f69225c5be5e5817a4008792e974ba4014c9e1 Mon Sep 17 00:00:00 2001
From: Boris Filippov <bfilippov@griddynamics.com>
Date: Wed, 5 Sep 2012 05:40:05 +0400
Subject: [PATCH 12/21] Use bare container format by default

Set container_format to bare during libvirt snapshot, when VM image in
glance was deleted. Currently, if VM image in glance was already deleted
before snapshot, nova will attempt to create snapshot image with
container_format: None. This cause glance to return error on attempt to
upload snapshot. According to glance docs container_format is not used
anywhere in glance or nova explicitly and it is safe to set it to bare,
when you are unsure which container_format you need to use.
Current snapshot logic sets snapshot disk_format to currently used
image_format in absence of base image in glance.

This resolves bug 921774 without need for snapshot mechanism redesign.

Change-Id: I7beea35120aaeac0837daecdf58f38f62e24454c
---
 Authors                         | 1 +
 nova/virt/libvirt/connection.py | 3 +--
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/Authors b/Authors
index 2653a63..c8b8269 100644
--- a/Authors
+++ b/Authors
@@ -22,6 +22,7 @@ Asbj√∏rn Sannes <asbjorn.sannes@interhost.no>
 Ben McGraw <ben@pistoncloud.com>
 Ben Swartzlander <bswartz@netapp.com>
 Bilal Akhtar <bilalakhtar@ubuntu.com>
+Boris Filippov <bfilippov@griddynamics.com>
 Brad Hall <brad@nicira.com>
 Brad McConnell <bmcconne@rackspace.com>
 Brendan Maguire <B_Maguire@Dell.com>
diff --git a/nova/virt/libvirt/connection.py b/nova/virt/libvirt/connection.py
index da072be..00d7c1e 100644
--- a/nova/virt/libvirt/connection.py
+++ b/nova/virt/libvirt/connection.py
@@ -695,8 +695,7 @@ class LibvirtConnection(driver.ComputeDriver):
         else:
             metadata['disk_format'] = image_format
 
-        if 'container_format' in base:
-            metadata['container_format'] = base['container_format']
+        metadata['container_format'] = base.get('container_format', 'bare')
 
         # Find the disk
         xml_desc = virt_dom.XMLDesc(0)
-- 
1.7.11.4

