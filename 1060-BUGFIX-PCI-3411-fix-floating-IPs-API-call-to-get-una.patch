From f473feea6e384d08f953285e167066ceb2411022 Mon Sep 17 00:00:00 2001
From: Tomas Dubec <tomas.dubec@gooddata.com>
Date: Tue, 18 Feb 2014 12:47:56 +0100
Subject: [PATCH] BUGFIX: PCI-3411 fix floating IPs API call to get unassigned
 addresses

---
 nova/api/openstack/compute/contrib/floating_ips.py | 1 +
 nova/db/sqlalchemy/api.py                          | 2 +-
 2 files changed, 2 insertions(+), 1 deletion(-)

diff --git a/nova/api/openstack/compute/contrib/floating_ips.py b/nova/api/openstack/compute/contrib/floating_ips.py
index 49c7fe4..4c13717 100644
--- a/nova/api/openstack/compute/contrib/floating_ips.py
+++ b/nova/api/openstack/compute/contrib/floating_ips.py
@@ -167,6 +167,7 @@ class FloatingIPController(object):
 
         search_opts = {}
         search_opts['project_id'] = context.project_id
+        search_opts['deleted'] = False
         all_instances = self.compute_api.get_all(context, search_opts)
 
         for floating_ip in floating_ips:
diff --git a/nova/db/sqlalchemy/api.py b/nova/db/sqlalchemy/api.py
index 543d67c..bcc73c9 100644
--- a/nova/db/sqlalchemy/api.py
+++ b/nova/db/sqlalchemy/api.py
@@ -908,7 +908,7 @@ def floating_ip_get_all_by_project(context, project_id):
     authorize_project_context(context, project_id)
     fl_ip_list = _floating_ip_get_all(context).\
                     filter_by(project_id=project_id).\
-                    join(models.FixedIp, models.FixedIp.id==models.FloatingIp.fixed_ip_id).\
+                    outerjoin(models.FixedIp, models.FixedIp.id==models.FloatingIp.fixed_ip_id).\
                     add_column(models.FixedIp.instance_uuid.label("floating_ips_instance_uuid")).\
                     add_column(models.FixedIp.address.label("floating_ips_fixed_ip")).\
                     all()
-- 
1.8.5.4

