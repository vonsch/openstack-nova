From 0d820f4d7ba338d36274c9b111148fef6d300b1b Mon Sep 17 00:00:00 2001
From: Tomas Dubec <tomas.dubec@gooddata.com>
Date: Mon, 30 Sep 2013 13:35:10 +0200
Subject: [PATCH] FEATURE: PCI-2238 return host in descr. instances and allow
 volume deletion for non-admin

---
 nova/api/ec2/cloud.py     | 4 +++-
 nova/db/sqlalchemy/api.py | 2 +-
 2 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/nova/api/ec2/cloud.py b/nova/api/ec2/cloud.py
index e47aaef..550de71 100644
--- a/nova/api/ec2/cloud.py
+++ b/nova/api/ec2/cloud.py
@@ -1123,10 +1123,12 @@ class CloudController(object):
             i['dnsName'] = i['publicDnsName'] or i['privateDnsName']
             i['keyName'] = instance['key_name']
 
-            if context.is_admin:
+            # PCI-2238: this used to be for admin contexts only.
+            if context.is_admin or "poweruser" in context.roles:
                 i['keyName'] = '%s (%s, %s)' % (i['keyName'],
                     instance['project_id'],
                     instance['host'])
+
             i['productCodesSet'] = utils.convert_to_list_dict([],
                                                               'product_codes')
             self._format_instance_type(instance, i)
diff --git a/nova/db/sqlalchemy/api.py b/nova/db/sqlalchemy/api.py
index 878639a..43eb95c 100644
--- a/nova/db/sqlalchemy/api.py
+++ b/nova/db/sqlalchemy/api.py
@@ -2984,7 +2984,7 @@ def volume_data_get_for_project(context, project_id, session=None):
     return (result[0] or 0, result[1] or 0)
 
 
-@require_admin_context
+@require_context
 def volume_destroy(context, volume_id):
     session = get_session()
     with session.begin():
-- 
1.8.4

