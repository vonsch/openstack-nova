From d53d5c471f06dada76cb6b936955982bd63d1e3c Mon Sep 17 00:00:00 2001
From: Jaroslav Pulchart <jaroslav.pulchart@gooddata.com>
Date: Wed, 12 Sep 2012 10:07:37 +0200
Subject: [PATCH 4/8] libvirt target dev attribute accept basename only

---
 nova/virt/libvirt/volume.py | 9 +++++----
 1 file changed, 5 insertions(+), 4 deletions(-)

diff --git a/nova/virt/libvirt/volume.py b/nova/virt/libvirt/volume.py
index 10338c2..9680a05 100644
--- a/nova/virt/libvirt/volume.py
+++ b/nova/virt/libvirt/volume.py
@@ -18,6 +18,7 @@
 """Volume drivers for libvirt."""
 
 import os
+from os.path import  basename
 import time
 
 from nova import exception
@@ -47,7 +48,7 @@ class LibvirtVolumeDriver(object):
                      <driver name='%s' type='raw' cache='none'/>
                      <source dev='%s'/>
                      <target dev='%s' bus='virtio'/>
-                 </disk>""" % (driver, device_path, mount_device)
+                 </disk>""" % (driver, device_path, basename(mount_device))
         return xml
 
     def disconnect_volume(self, connection_info, mount_device):
@@ -65,7 +66,7 @@ class LibvirtFakeVolumeDriver(LibvirtVolumeDriver):
                      <driver name='qemu' type='raw' cache='none'/>
                      <source protocol='%s' name='%s'/>
                      <target dev='%s' bus='virtio'/>
-                 </disk>""" % (protocol, name, mount_device)
+                 </disk>""" % (protocol, name, basename(mount_device))
         return xml
 
 
@@ -88,13 +89,13 @@ class LibvirtNetVolumeDriver(LibvirtVolumeDriver):
                          </auth>
                          <target dev='%s' bus='virtio'/>
                      </disk>""" % (driver, protocol, name, username,
-                                   secret_type, secret_uuid, mount_device)
+                                   secret_type, secret_uuid, basename(mount_device))
         else:
             xml = """<disk type='network'>
                          <driver name='%s' type='raw' cache='none'/>
                          <source protocol='%s' name='%s'/>
                          <target dev='%s' bus='virtio'/>
-                     </disk>""" % (driver, protocol, name, mount_device)
+                     </disk>""" % (driver, protocol, name, basename(mount_device))
         return xml
 
 
-- 
1.7.11.7

