From 6337270f9a8f033c26b0e645d0094ee823837202 Mon Sep 17 00:00:00 2001
From: Brano Zarnovican <branislav.zarnovican@gooddata.com>
Date: Wed, 22 May 2013 11:51:42 +0200
Subject: [PATCH 1/2] Do not run RPC call for simple db look at fixed_ip set.

original Jarda's patch, modified by Zdenek for Folsom
---
 nova/virt/firewall.py | 22 ++++++++--------------
 1 file changed, 8 insertions(+), 14 deletions(-)

diff --git a/nova/virt/firewall.py b/nova/virt/firewall.py
index a093a35..95a6af8 100644
--- a/nova/virt/firewall.py
+++ b/nova/virt/firewall.py
@@ -405,21 +405,15 @@ class IptablesFirewallDriver(FirewallDriver):
                     fw_rules += [' '.join(args)]
                 else:
                     if rule['grantee_group']:
-                        # FIXME(jkoelker) This needs to be ported up into
-                        #                 the compute manager which already
-                        #                 has access to a nw_api handle,
-                        #                 and should be the only one making
-                        #                 making rpc calls.
-                        nw_api = network.API()
                         for instance in rule['grantee_group']['instances']:
-                            nw_info = nw_api.get_instance_nw_info(ctxt,
-                                                                  instance)
-
-                            ips = [ip['address']
-                                for ip in nw_info.fixed_ips()
-                                    if ip['version'] == version]
-
-                            LOG.debug('ips: %r', ips, instance=instance)
+                            try:
+                                ips = [ip['address']
+                                    for ip in db.fixed_ip_get_by_instance(ctxt, instance['uuid'])]
+                            except:
+                                ips = []
+                            
+                            LOG.debug('ips: %r', ips)
+                            
                             for ip in ips:
                                 subrule = args + ['-s %s' % ip]
                                 fw_rules += [' '.join(subrule)]
-- 
1.8.1.4

