From 598b68f4ead7d50517c831eb2253a8cdf33f7a27 Mon Sep 17 00:00:00 2001
From: Tomas Dubec <tomas.dubec@gooddata.com>
Date: Wed, 28 Aug 2013 13:46:56 +0200
Subject: [PATCH 5/5] BUGFIX: PCI-2025 delete domain after unsuccessful
 instance spawn

---
 nova/virt/libvirt/driver.py | 9 ++++++++-
 1 file changed, 8 insertions(+), 1 deletion(-)

diff --git a/nova/virt/libvirt/driver.py b/nova/virt/libvirt/driver.py
index 7022d9c..8ada675 100644
--- a/nova/virt/libvirt/driver.py
+++ b/nova/virt/libvirt/driver.py
@@ -1977,7 +1977,14 @@ class LibvirtDriver(driver.ComputeDriver):
         self.plug_vifs(instance, network_info)
         self.firewall_driver.setup_basic_filtering(instance, network_info)
         self.firewall_driver.prepare_instance_filter(instance, network_info)
-        domain = self._create_domain(xml)
+        try:
+            domain = self._create_domain(xml)
+        except Exception, e:
+            try:
+                raise
+            finally:
+                self.destroy(instance, network_info, block_device_info)
+
         self.firewall_driver.apply_instance_filter(instance, network_info)
         return domain
 
-- 
1.8.3.4

