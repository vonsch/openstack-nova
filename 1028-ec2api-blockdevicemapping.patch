--- a/nova/api/ec2/cloud.py.orig	2013-03-18 17:30:58.000000000 +0100
+++ b/nova/api/ec2/cloud.py	2013-04-17 15:39:31.000000000 +0200
@@ -103,12 +103,13 @@
     ebs = bdm.pop('ebs', None)
     if ebs:
         ec2_id = ebs.pop('snapshot_id', None)
-        if ec2_id:
-            id = ec2utils.ec2_vol_id_to_uuid(ec2_id)
-            if ec2_id.startswith('snap-'):
-                bdm['snapshot_id'] = id
-            elif ec2_id.startswith('vol-'):
-                bdm['volume_id'] = id
+	if ec2_id:
+	    snaptpl=FLAGS.snapshot_name_template.split('%')[0]
+            volutpl=FLAGS.volume_name_template.split('%')[0]
+            if ec2_id.startswith(snaptpl):
+		bdm['snapshot_id'] = ec2utils.ec2_snap_id_to_uuid(ec2_id)
+	    elif ec2_id.startswith(volutpl):
+		bdm['volume_id'] = ec2utils.ec2_vol_id_to_uuid(ec2_id)
             ebs.setdefault('delete_on_termination', True)
         bdm.update(ebs)
     return bdm
