From 394e43ba6892a4a2922d56e90f33a5f05b0cc1af Mon Sep 17 00:00:00 2001
From: Jaroslav Pulchart <jaroslav.pulchart@gooddata.com>
Date: Wed, 26 Jun 2013 22:16:06 +0200
Subject: [PATCH] FEATURE: Enable hugepages memory backend for libvirt.

---
 nova/virt/libvirt/config.py | 8 ++++++++
 nova/virt/libvirt/driver.py | 6 ++++++
 2 files changed, 14 insertions(+)

diff --git a/nova/virt/libvirt/config.py b/nova/virt/libvirt/config.py
index 1daf236..f873675 100644
--- a/nova/virt/libvirt/config.py
+++ b/nova/virt/libvirt/config.py
@@ -586,6 +586,7 @@ class LibvirtConfigGuest(LibvirtConfigObject):
         self.cpu = None
         self.acpi = False
         self.apic = False
+        self.hugepages = False
         self.clock = None
         self.os_type = None
         self.os_loader = None
@@ -622,6 +623,12 @@ class LibvirtConfigGuest(LibvirtConfigObject):
             os.append(etree.Element("boot", dev=self.os_boot_dev))
         root.append(os)
 
+    def _format_memorybacking(self, root):
+        if self.hugepages:
+            memorybacking = etree.Element("memoryBacking")
+            memorybacking.append(etree.Element("hugepages"))
+            root.append(memorybacking)
+
     def _format_features(self, root):
         if self.acpi or self.apic:
             features = etree.Element("features")
@@ -646,6 +653,7 @@ class LibvirtConfigGuest(LibvirtConfigObject):
 
         self._format_basic_props(root)
         self._format_os(root)
+        self._format_memorybacking(root)
         self._format_features(root)
 
         if self.clock is not None:
diff --git a/nova/virt/libvirt/driver.py b/nova/virt/libvirt/driver.py
index 9ef21b8..dc65047 100644
--- a/nova/virt/libvirt/driver.py
+++ b/nova/virt/libvirt/driver.py
@@ -100,6 +100,9 @@ libvirt_opts = [
                default='kvm',
                help='Libvirt domain type (valid options are: '
                     'kvm, lxc, qemu, uml, xen)'),
+    cfg.StrOpt('libvirt_hugepages',
+               default=False,
+               help='Libvirt hugepages memory backed'),
     cfg.StrOpt('libvirt_uri',
                default='',
                help='Override the default libvirt URI '
@@ -1801,6 +1804,9 @@ class LibvirtDriver(driver.ComputeDriver):
             guest.acpi = True
             guest.apic = True
 
+        if FLAGS.libvirt_hugepages == True:
+            guest.hugepages = True
+
         clk = config.LibvirtConfigGuestClock()
         clk.offset = "utc"
         guest.set_clock(clk)
-- 
1.8.3.1

