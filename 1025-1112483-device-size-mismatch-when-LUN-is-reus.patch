From 5abf9a1ebd7f17910c06f5d07fa67c1107934cb6 Mon Sep 17 00:00:00 2001
From: Brano Zarnovican <branislav.zarnovican@gooddata.com>
Date: Wed, 17 Apr 2013 15:24:46 +0200
Subject: [PATCH] BUGFIX: #1112483 - device size mismatch when LUN is reused

---
 etc/nova/rootwrap.d/compute.filters |  1 +
 nova/virt/libvirt/volume.py         | 11 +++++++++++
 2 files changed, 12 insertions(+)

diff --git a/etc/nova/rootwrap.d/compute.filters b/etc/nova/rootwrap.d/compute.filters
index db9ee26..17528a9 100644
--- a/etc/nova/rootwrap.d/compute.filters
+++ b/etc/nova/rootwrap.d/compute.filters
@@ -59,6 +59,7 @@ chown: CommandFilter, /bin/chown, root
 chmod: CommandFilter, /bin/chmod, root
 
 # nova/virt/disk/api.py: 'cp', os.path.join(fs...
+# nova/virt/libvirt/volume.py: echo 1 | cp /dev/stdin /sys/block/..
 cp: CommandFilter, /bin/cp, root
 
 # nova/virt/libvirt/vif.py: 'ip', 'tuntap', 'add', dev, 'mode', 'tap'
diff --git a/nova/virt/libvirt/volume.py b/nova/virt/libvirt/volume.py
index cf08ea8..74e1822 100644
--- a/nova/virt/libvirt/volume.py
+++ b/nova/virt/libvirt/volume.py
@@ -204,3 +204,14 @@ class LibvirtISCSIVolumeDriver(LibvirtVolumeDriver):
                                check_exit_code=[0, 21, 255])
             self._run_iscsiadm(iscsi_properties, ('--op', 'delete'),
                                check_exit_code=[0, 21, 255])
+        else:
+            # can't close the session, at least delete the device for disconnected vol
+            if not 'target_lun' in iscsi_properties:
+                return
+            host_device = device_prefix+str(iscsi_properties['target_lun'])
+            device_shortname = os.path.basename(os.path.realpath(host_device))
+            delete_ctl_file = '/sys/block/'+device_shortname+'/device/delete'
+            if os.path.exists(delete_ctl_file):
+                # echo 1 > /sys/block/sdX/device/delete
+                utils.execute('cp', '/dev/stdin', delete_ctl_file,
+                              process_input='1', run_as_root=True)
-- 
1.8.1.4

